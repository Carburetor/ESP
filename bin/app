#!/usr/bin/env bash

executable="$0"
project="${PROJECT_PATH:-$PWD}"

default_database_name='eventstore'
database="${DATABASE_NAME:-$default_database_name}"

err_invalid_command=1

exec_psql() {
  PGOPTIONS='--client-min-messages=warning' \
    psql \
      -X -q -a -v ON_ERROR_STOP=1 --pset pager=off \
      -f "$1"
}

perform() {
  case "$1" in
    setup)
      perform boot
      perform load-code
      perform load-schema
      ;;

    boot)
      set -e
        PGOPTIONS='--client-min-messages=warning' \
          psql \
            -X -q -a -v ON_ERROR_STOP=1 --pset pager=off \
            -d "$PGUSER" \
            -f "$project/app/boot.psql"
      set +e
      ;;

    load-schema)
      set -e
        exec_psql "$project/app/schema.psql"
      set +e
      ;;

    load-code)
      set -e
        exec_psql "$project/app/code.psql"
      set +e
      ;;

    console)
      psql
      ;;

    test)
      pg_prove --recurse --trap --jobs 4 --shuffle --ext=pg --runtests \
        "$project/tests/hello_world.pg"
      ;;

    shortlist)
      echo 'setup reload console test'
      ;;

    *)
      if [[ ! -z "${1// }" ]]; then
        echo $"Invalid command: $1"
      fi
      local shortlist="$(perform shortlist)"
      echo $"Usage: $executable ${shortlist// /|}"
      exit $err_invalid_command
      ;;

  esac
}

pushd "$project" > /dev/null
perform "$@"
performed_result=$?
popd > /dev/null

exit $performed_result
