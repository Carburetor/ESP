#!/usr/bin/env bash

executable="$0"
project="${PROJECT_PATH:-$PWD}"

default_database_name='eventstore'
database="${DATABASE_NAME:-$default_database_name}"

err_invalid_command=1

exec_psql() {
  PGOPTIONS='--client-min-messages=warning' \
    psql \
      -X -q -a -v ON_ERROR_STOP=1 --pset pager=off \
      -f "$1"
}

exec_psql_quiet() {
  PGOPTIONS='--client-min-messages=warning' \
    psql \
      -X -q -v ON_ERROR_STOP=1 --pset pager=off \
      -f "$1"
}

perform() {
  case "$1" in
    setup)
      perform boot
      perform load-code
      perform load-structure
      ;;

    boot)
      set -e
        PGOPTIONS='--client-min-messages=warning' \
          psql \
            -X -q -a -v ON_ERROR_STOP=1 --pset pager=off \
            -d "$PGUSER" \
            -f "$project/app/boot.psql"
      set +e
      ;;

    load-structure)
      set -e
        exec_psql "$project/app/structure.psql"
      set +e
      ;;

    load-code)
      set -e
        exec_psql "$project/app/code.psql"
      set +e
      ;;

    console)
      psql
      ;;

    test)
      while IFS= read -d $'\0' -r file ; do
        exec_psql_quiet "$file"
      done < <(find 'tests/' -iname '*.pg' -print0)
      pg_prove \
        --recurse --trap --shuffle --ext=pg --runtests \
        --failures --verbose --match '^test\s'
      ;;

    shortlist)
      echo 'setup console test boot load-code load-structure'
      ;;

    *)
      if [[ ! -z "${1// }" ]]; then
        echo $"Invalid command: $1"
      fi
      local shortlist="$(perform shortlist)"
      echo $"Usage: $executable ${shortlist// /|}"
      exit $err_invalid_command
      ;;

  esac
}

pushd "$project" > /dev/null
perform "$@"
performed_result=$?
popd > /dev/null

exit $performed_result
